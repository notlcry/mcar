<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æœºå™¨äººæ§åˆ¶</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/nipplejs@0.9.0/dist/nipplejs.min.js"></script>
    <style>
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8f9fa;
            height: 100vh;
            touch-action: none;
            overflow: hidden;
        }
        .container {
            max-width: 100%;
            height: 100%;
            padding: 10px;
        }
        .title {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
        }
        .controls-container {
            display: flex;
            flex-direction: column;
            height: 80vh;
        }
        .video-container {
            position: relative;
            width: 100%;
            height: 0;
            padding-bottom: 56.25%; /* æ”¹ä¸º16:9æ¯”ä¾‹ */
            margin-bottom: 10px;
            border-radius: 10px;
            overflow: hidden;
            background-color: #000;
        }
        .video-feed {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain; /* ä¿æŒæ¯”ä¾‹ï¼Œä¸è£å‰ª */
        }
        .video-controls {
            position: absolute;
            bottom: 5px;
            right: 5px;
            z-index: 10;
        }
        .video-toggle {
            background-color: rgba(0,0,0,0.6);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 3px 8px;
            cursor: pointer;
            font-size: 10px;
        }
        .joystick-area {
            flex: 1;
            position: relative;
            background-color: rgba(200, 200, 200, 0.1);
            border-radius: 10px;
            margin-bottom: 10px;
        }
        .joystick-label {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
        }
        .control-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        .btn-control {
            font-size: 18px;
            font-weight: bold;
            border: none;
            border-radius: 12px;
            padding: 15px 8px;
            color: white;
            background-color: #4287f5;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: all 0.2s;
            min-height: 50px;
            cursor: pointer;
            user-select: none;
        }
        .btn-control:active {
            transform: scale(0.95);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .btn-stop {
            background-color: #f44336;
            grid-column: 2;
            font-size: 20px;
        }
        .btn-control:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }
        .status-panel {
            background-color: #333;
            color: #0f0;
            font-family: monospace;
            padding: 5px;
            border-radius: 5px;
            height: 60px;
            overflow-y: auto;
            margin-bottom: 10px;
            font-size: 12px;
        }
        .speed-control {
            background-color: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 10px;
        }
        .speed-slider {
            width: 100%;
            margin: 5px 0;
        }
        @media (min-width: 768px) {
            .controls-container {
                flex-direction: row;
            }
            .joystick-area {
                flex: 2;
                margin-right: 10px;
                margin-bottom: 0;
            }
            .controls-panel {
                flex: 1;
                display: flex;
                flex-direction: column;
            }
        }
        @media (max-width: 768px) {
            .container {
                padding: 5px;
            }
            .title {
                font-size: 1.2rem;
                margin-bottom: 5px;
            }
            .controls-container {
                height: auto; 
                min-height: 40vh; /* å‡å°‘æœ€å°é«˜åº¦ */
            }
            .joystick-area {
                height: 150px; /* å‡å°é«˜åº¦ */
                min-height: 150px;
            }
            /* ç¡®ä¿åœ¨å°å±å¹•ä¸Šæ§åˆ¶é¢æ¿å¯è§ */
            .controls-panel {
                margin-bottom: 60px;
            }
            /* ä¼˜åŒ–ç§»åŠ¨ç«¯æŒ‰é’®å¤§å° */
            .control-buttons {
                gap: 8px;
            }
            .btn-control {
                font-size: 16px;
                padding: 12px 8px;
                min-height: 45px;
            }
            /* ç¡®ä¿é€Ÿåº¦æ§åˆ¶åœ¨iPhoneä¸Šå¯è§ */
            .speed-control {
                margin-top: 10px;
                margin-bottom: 10px;
                padding: 10px;
            }
            .speed-slider {
                height: 25px;
                margin: 5px 0;
            }
            /* çŠ¶æ€æ˜¾ç¤ºåŒºè°ƒæ•´ */
            .status-panel {
                height: 60px;
                padding: 5px;
                font-size: 12px;
                margin-bottom: 10px;
            }
            /* å¸®åŠ©é¢æ¿è°ƒæ•´ */
            .help-panel {
                font-size: 12px !important;
                padding: 5px !important;
            }
            /* è§†é¢‘æ§ä»¶è°ƒæ•´ */
            .video-controls {
                bottom: 5px;
                right: 5px;
            }
            .video-toggle {
                padding: 3px 8px;
                font-size: 10px;
            }
        }
        /* æ·»åŠ é€‚é…å…¨é¢å±iPhoneçš„æ ·å¼ */
        @media only screen 
        and (device-width: 375px) 
        and (device-height: 812px) 
        and (-webkit-device-pixel-ratio: 3),
        only screen 
        and (device-width: 414px) 
        and (device-height: 896px) 
        and (-webkit-device-pixel-ratio: 2),
        only screen 
        and (device-width: 390px) 
        and (device-height: 844px) 
        and (-webkit-device-pixel-ratio: 3),
        only screen 
        and (device-width: 428px) 
        and (device-height: 926px) 
        and (-webkit-device-pixel-ratio: 3) {
            /* iPhone X, XS, 11 Pro, 12, 13 Pro, 14 Pro ç­‰å…¨é¢å±è®¾å¤‡ */
            .container {
                padding-bottom: env(safe-area-inset-bottom);
                padding-top: env(safe-area-inset-top);
            }
            
            .joystick-area {
                height: 120px; /* æ›´å°çš„æ‘‡æ†åŒºåŸŸ */
                min-height: 120px;
            }
            
            .control-buttons {
                margin-bottom: 8px;
            }
            
            .status-panel {
                height: 50px;
            }
        }
        
        /* ä¼ æ„Ÿå™¨æ˜¾ç¤ºæ ·å¼ */
        .sensor-panel {
            background-color: rgba(0,0,0,0.9);
            color: #fff;
            position: absolute;
            bottom: 10px;
            left: 10px;
            padding: 12px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: bold;
            z-index: 10;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 16px rgba(0,0,0,0.5);
            border: 2px solid rgba(255,255,255,0.3);
            min-width: 140px;
        }
        .sensor-badge {
            display: inline-flex;
            margin: 3px 0;
            padding: 8px 10px;
            border-radius: 8px;
            align-items: center;
            font-size: 13px;
            font-weight: bold;
        }
        .sensor-badge.safe {
            background-color: #4caf50;
        }
        .sensor-badge.warning {
            background-color: #ff9800;
        }
        .sensor-badge.danger {
            background-color: #f44336;
        }
        .sensor-icon {
            width: 16px;
            height: 16px;
            margin-right: 8px;
            text-align: center;
            font-size: 16px;
        }

        /* å¼€å…³æŒ‰é’®æ ·å¼ */
        .switch-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 8px 0;
            padding: 6px;
            background-color: rgba(255,255,255,0.1);
            border-radius: 8px;
            font-size: 13px;
            font-weight: bold;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 22px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 22px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #4caf50;
        }
        input:checked + .slider:before {
            transform: translateX(18px);
        }
    </style>
</head>
<body>
    <div class="container">
        <h2 class="title">ğŸ¤– æ™ºèƒ½æœºå™¨äººé¥æ§ç³»ç»Ÿ</h2>
        
        <!-- è§†é¢‘åŒºåŸŸ - æ›´å°çš„è§†é¢‘åŒºåŸŸ -->
        <div class="video-container" style="padding-bottom: 40%;">
            <img src="/video_feed" alt="æœºå™¨äººæ‘„åƒå¤´" class="video-feed" id="video-feed">
            <div class="video-controls">
                <button class="video-toggle" id="video-toggle">å…³é—­</button>
                <button class="video-toggle" id="video-restart" style="margin-left: 3px;">é‡å¯</button>
                <span class="video-status" id="camera-type" style="margin-left: 3px; color: white; font-size: 10px;"></span>
            </div>
            
            <!-- ä¼ æ„Ÿå™¨é¢æ¿ -->
            <div class="sensor-panel" id="sensor-panel">
                <div class="sensor-badge" id="ultrasonic-badge">
                    <span class="sensor-icon">âš¡</span>
                    <span id="ultrasonic-value">è·ç¦»: 100cm</span>
                </div>
                <div class="sensor-badge" id="left-ir-badge">
                    <span class="sensor-icon">â†</span>
                    <span id="left-ir-value">å·¦ä¾§: å®‰å…¨</span>
                </div>
                <div class="sensor-badge" id="right-ir-badge">
                    <span class="sensor-icon">â†’</span>
                    <span id="right-ir-value">å³ä¾§: å®‰å…¨</span>
                </div>
                <div class="switch-container">
                    <span>ğŸ›¡ï¸ è‡ªåŠ¨é¿éšœ</span>
                    <label class="switch">
                        <input type="checkbox" id="avoidance-toggle">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </div>
        
        <!-- ç§»åŠ¨è®¾å¤‡é€Ÿåº¦æ§åˆ¶ - ä»…åœ¨å°å±å¹•ä¸Šæ˜¾ç¤º -->
        <div class="speed-control mobile-speed" style="display: none; margin: 5px 0; padding: 8px;">
            <label for="speed-mobile" style="font-size: 12px;">é€Ÿåº¦: <span id="speed-value-mobile">50%</span></label>
            <input type="range" id="speed-mobile" class="speed-slider" min="0" max="100" value="50">
        </div>
        
        <div class="controls-container">
            <!-- å·¦ä¾§æ‘‡æ†æ§åˆ¶åŒº -->
            <div class="joystick-area" id="joystick-zone">
                <div class="joystick-label">ç§»åŠ¨æ§åˆ¶</div>
            </div>
            
            <!-- å³ä¾§æ§åˆ¶é¢æ¿ -->
            <div class="controls-panel">
                <!-- æœºå™¨äººçŠ¶æ€æŒ‡ç¤ºå™¨ -->
                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                    <div id="robot-status-indicator" style="width: 12px; height: 12px; border-radius: 50%; background-color: #4caf50; margin-right: 8px;"></div>
                    <span id="robot-status-text" style="font-weight: bold; font-size: 14px;">æœºå™¨äººåœ¨çº¿</span>
                    <span id="current-action" style="margin-left: auto; font-size: 12px; color: #666;">å¾…æœºä¸­</span>
                </div>
                
                <!-- çŠ¶æ€æ˜¾ç¤º -->
                <div class="status-panel" id="status">
                    ç³»ç»Ÿå°±ç»ª...
                </div>
                
                <!-- æŒ‰é’®æ§åˆ¶ - ç®€åŒ–å¸ƒå±€ -->
                <div class="control-buttons">
                    <button class="btn-control" id="forward-btn">â¬†ï¸ å‰è¿›</button>
                    <button class="btn-control btn-stop" id="stop-btn">ğŸ›‘ åœæ­¢</button>
                    <button class="btn-control" id="backward-btn">â¬‡ï¸ åé€€</button>
                    <button class="btn-control" id="left-btn">â¬…ï¸ å·¦è½¬</button>
                    <button class="btn-control" id="sensor-test-btn" style="background-color: #ff9800;">ğŸ” ä¼ æ„Ÿå™¨</button>
                    <button class="btn-control" id="right-btn">â¡ï¸ å³è½¬</button>
                </div>
                
                <!-- é€Ÿåº¦æ§åˆ¶ - æ¡Œé¢ç‰ˆ -->
                <div class="speed-control desktop-speed">
                    <label for="speed" style="font-size: 14px;">é€Ÿåº¦æ§åˆ¶: <span id="speed-value">50%</span></label>
                    <input type="range" id="speed" class="speed-slider" min="0" max="100" value="50">
                </div>
                
                <!-- æç®€ç‰ˆå¸®åŠ©ä¿¡æ¯ -->
                <div class="help-panel" style="margin-top: 5px; padding: 5px; background-color: #f8f9fa; border-radius: 8px; font-size: 12px;">
                    <details>
                        <summary style="font-weight: bold; cursor: pointer;">ä½¿ç”¨å¸®åŠ©</summary>
                        <div style="margin-top: 5px; font-size: 11px;">
                            <p style="margin: 3px 0"><strong>æ‘‡æ†:</strong> æ‹–åŠ¨æ§åˆ¶æ–¹å‘</p>
                            <p style="margin: 3px 0"><strong>æŒ‰é’®:</strong> æŒ‰ä½ç§»åŠ¨ï¼Œæ¾å¼€åœæ­¢</p>
                            <p style="margin: 3px 0"><strong>æ–¹å‘:</strong> â†‘â†“â†â†’â†–â†—â†™â†˜â†ºâ†»</p>
                        </div>
                    </details>
                </div>
            </div>
        </div>
    </div>

    <script>
        // çŠ¶æ€æ›´æ–°å‡½æ•°
        function updateStatus(message) {
            const statusEl = document.getElementById('status');
            const timestamp = new Date().toLocaleTimeString();
            statusEl.innerHTML = `[${timestamp}] ${message}<br>` + statusEl.innerHTML;
        }
        
        // å‘½ä»¤å‘é€å‡½æ•°
        function sendCommand(command) {
            updateStatus(`å‘é€å‘½ä»¤: ${command}`);
            updateCurrentAction(command);
            fetch('/control', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({command: command})
            }).then(response => {
                if (!response.ok) {
                    updateStatus('å‘½ä»¤å‘é€å¤±è´¥');
                    updateRobotStatus('ç¦»çº¿', '#f44336');
                } else {
                    updateRobotStatus('åœ¨çº¿', '#4caf50');
                }
            }).catch(error => {
                updateStatus(`é”™è¯¯: ${error.message}`);
                updateRobotStatus('è¿æ¥é”™è¯¯', '#f44336');
            });
        }
        
        // æ›´æ–°æœºå™¨äººçŠ¶æ€æŒ‡ç¤ºå™¨
        function updateRobotStatus(text, color) {
            document.getElementById('robot-status-indicator').style.backgroundColor = color;
            document.getElementById('robot-status-text').textContent = `æœºå™¨äºº${text}`;
        }
        
        // æ›´æ–°å½“å‰åŠ¨ä½œ
        function updateCurrentAction(command) {
            const actionMap = {
                'forward': 'å‰è¿›',
                'backward': 'åé€€', 
                'left': 'å·¦è½¬',
                'right': 'å³è½¬',
                'move_left': 'å·¦ç§»',
                'move_right': 'å³ç§»',
                'forward_left': 'å‰å·¦',
                'forward_right': 'å‰å³',
                'backward_left': 'åå·¦',
                'backward_right': 'åå³',
                'stop': 'å¾…æœºä¸­'
            };
            document.getElementById('current-action').textContent = actionMap[command] || command;
        }
        
        // è®¾ç½®é€Ÿåº¦å‡½æ•°
        function setSpeed(speed) {
            document.getElementById('speed-value').textContent = speed + '%';
            fetch('/speed', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({speed: parseInt(speed)})
            }).then(response => {
                if (response.ok) {
                    updateStatus(`é€Ÿåº¦è®¾ç½®ä¸º: ${speed}%`);
                }
            });
        }
        
        // åˆå§‹åŒ–æŒ‰é’®äº‹ä»¶
        document.getElementById('forward-btn').addEventListener('touchstart', () => sendCommand('forward'));
        document.getElementById('forward-btn').addEventListener('touchend', () => sendCommand('stop'));
        document.getElementById('forward-btn').addEventListener('mousedown', () => sendCommand('forward'));
        document.getElementById('forward-btn').addEventListener('mouseup', () => sendCommand('stop'));
        
        document.getElementById('backward-btn').addEventListener('touchstart', () => sendCommand('backward'));
        document.getElementById('backward-btn').addEventListener('touchend', () => sendCommand('stop'));
        document.getElementById('backward-btn').addEventListener('mousedown', () => sendCommand('backward'));
        document.getElementById('backward-btn').addEventListener('mouseup', () => sendCommand('stop'));
        
        document.getElementById('left-btn').addEventListener('touchstart', () => sendCommand('left'));
        document.getElementById('left-btn').addEventListener('touchend', () => sendCommand('stop'));
        document.getElementById('left-btn').addEventListener('mousedown', () => sendCommand('left'));
        document.getElementById('left-btn').addEventListener('mouseup', () => sendCommand('stop'));
        
        document.getElementById('right-btn').addEventListener('touchstart', () => sendCommand('right'));
        document.getElementById('right-btn').addEventListener('touchend', () => sendCommand('stop'));
        document.getElementById('right-btn').addEventListener('mousedown', () => sendCommand('right'));
        document.getElementById('right-btn').addEventListener('mouseup', () => sendCommand('stop'));
        
        document.getElementById('stop-btn').addEventListener('click', () => sendCommand('stop'));
        
        document.getElementById('speed').addEventListener('change', (event) => {
            setSpeed(event.target.value);
        });
        
        // åˆå§‹åŒ–æ‘‡æ†æ§åˆ¶
        const joystickOptions = {
            zone: document.getElementById('joystick-zone'),
            mode: 'static',
            position: {left: '50%', top: '50%'},
            color: '#4287f5',
            size: 140,
            threshold: 0.1,
            fadeTime: 250,
            lockX: false,
            lockY: false
        };
        
        const joystick = nipplejs.create(joystickOptions);
        
        let joystickTimer = null;
        const joystickDelay = 100; // å‘é€æŒ‡ä»¤çš„é—´éš”(æ¯«ç§’)
        let lastDirection = null;
        
        joystick.on('start', function() {
            updateStatus('æ‘‡æ†æ§åˆ¶å¯åŠ¨');
        });
        
        joystick.on('move', function(event, data) {
            if (joystickTimer) {
                return;
            }
            
            const angle = data.angle.degree;
            const force = Math.min(data.force, 1.0);
            let direction;
            
            // æ›´ç²¾ç¡®çš„æ–¹å‘æ§åˆ¶ï¼Œ8ä¸ªæ–¹å‘
            if (angle > 22.5 && angle <= 67.5) {
                direction = 'forward_right';
            } else if (angle > 67.5 && angle <= 112.5) {
                direction = 'forward';
            } else if (angle > 112.5 && angle <= 157.5) {
                direction = 'forward_left';
            } else if (angle > 157.5 && angle <= 202.5) {
                direction = 'move_left';
            } else if (angle > 202.5 && angle <= 247.5) {
                direction = 'backward_left';
            } else if (angle > 247.5 && angle <= 292.5) {
                direction = 'backward';
            } else if (angle > 292.5 && angle <= 337.5) {
                direction = 'backward_right';
            } else {
                direction = 'move_right';
            }
            
            if (direction !== lastDirection) {
                sendCommand(direction);
                lastDirection = direction;
                
                // æ›´æ–°çŠ¶æ€é¢æ¿ä¸­çš„æ–¹å‘æŒ‡ç¤º
                const directionMap = {
                    'forward': 'â†‘',
                    'backward': 'â†“',
                    'move_left': 'â†',
                    'move_right': 'â†’',
                    'forward_left': 'â†–',
                    'forward_right': 'â†—',
                    'backward_left': 'â†™',
                    'backward_right': 'â†˜',
                    'left': 'â†º',
                    'right': 'â†»'
                };
                
                const directionSymbol = directionMap[direction] || 'â€¢';
                updateStatus(`æ‘‡æ†æ§åˆ¶: ${directionSymbol} ${direction} (åŠ›åº¦: ${Math.round(force * 100)}%)`);
            }
            
            joystickTimer = setTimeout(function() {
                joystickTimer = null;
            }, joystickDelay);
        });
        
        joystick.on('end', function() {
            sendCommand('stop');
            lastDirection = null;
            updateStatus('æ‘‡æ†æ§åˆ¶åœæ­¢');
        });
        
        // é¡µé¢åŠ è½½å®Œæˆ
        window.addEventListener('load', function() {
            updateStatus('ç³»ç»Ÿå·²è¿æ¥ï¼Œç­‰å¾…å‘½ä»¤...');
            updateRobotStatus('åœ¨çº¿', '#4caf50');
            updateCurrentAction('stop');
            getCameraStatus();
        });
        
        // ç¦æ­¢é¡µé¢ç¼©æ”¾
        document.addEventListener('touchmove', function (event) {
            if (event.scale !== 1) {
                event.preventDefault();
            }
        }, { passive: false });
        
        // è§†é¢‘æ§åˆ¶åŠŸèƒ½
        const videoFeed = document.getElementById('video-feed');
        const videoToggle = document.getElementById('video-toggle');
        const videoRestart = document.getElementById('video-restart');
        const cameraType = document.getElementById('camera-type');
        let videoEnabled = true;
        
        // è·å–æ‘„åƒå¤´çŠ¶æ€
        function getCameraStatus() {
            fetch('/camera/status')
                .then(response => response.json())
                .then(data => {
                    cameraType.textContent = `æ‘„åƒå¤´ç±»å‹: ${data.camera_type === 'picamera' ? 'æ ‘è“æ´¾å®˜æ–¹' : 'æ™®é€šUSB'}`;
                    updateStatus(`æ‘„åƒå¤´çŠ¶æ€: ${data.enabled ? 'å¼€å¯' : 'å…³é—­'} (${data.camera_type})`);
                })
                .catch(error => {
                    console.error('è·å–æ‘„åƒå¤´çŠ¶æ€å¤±è´¥:', error);
                });
        }
        
        videoToggle.addEventListener('click', function() {
            if (videoEnabled) {
                // å…³é—­è§†é¢‘
                videoFeed.style.display = 'none';
                videoToggle.textContent = 'å¼€å¯è§†é¢‘';
                videoEnabled = false;
            } else {
                // å¼€å¯è§†é¢‘
                videoFeed.style.display = 'block';
                videoToggle.textContent = 'å…³é—­è§†é¢‘';
                videoEnabled = true;
                // é‡æ–°åŠ è½½è§†é¢‘æµ
                videoFeed.src = '/video_feed?t=' + new Date().getTime();
            }
            
            // é€šçŸ¥æœåŠ¡å™¨åˆ‡æ¢æ‘„åƒå¤´çŠ¶æ€
            fetch('/camera/toggle', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            }).then(response => response.json())
              .then(data => {
                  updateStatus(`æ‘„åƒå¤´çŠ¶æ€: ${data.enabled ? 'å¼€å¯' : 'å…³é—­'}`);
              });
        });
        
        // é‡å¯æ‘„åƒå¤´åŠŸèƒ½
        videoRestart.addEventListener('click', function() {
            updateStatus('æ­£åœ¨é‡å¯æ‘„åƒå¤´...');
            videoRestart.disabled = true;
            videoRestart.textContent = 'é‡å¯ä¸­...';
            
            fetch('/camera/restart', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            }).then(response => response.json())
              .then(data => {
                  updateStatus(`æ‘„åƒå¤´é‡å¯: ${data.message}`);
                  // æ›´æ–°æ‘„åƒå¤´ç±»å‹æ˜¾ç¤º
                  cameraType.textContent = `æ‘„åƒå¤´ç±»å‹: ${data.camera_type === 'picamera' ? 'æ ‘è“æ´¾å®˜æ–¹' : 'æ™®é€šUSB'}`;
                  // é‡æ–°åŠ è½½è§†é¢‘æµ
                  videoFeed.src = '/video_feed?t=' + new Date().getTime();
                  videoRestart.disabled = false;
                  videoRestart.textContent = 'é‡å¯æ‘„åƒå¤´';
              })
              .catch(error => {
                  updateStatus(`é‡å¯æ‘„åƒå¤´å¤±è´¥: ${error.message}`);
                  videoRestart.disabled = false;
                  videoRestart.textContent = 'é‡å¯æ‘„åƒå¤´';
              });
        });
        
        // å¤„ç†è§†é¢‘åŠ è½½é”™è¯¯
        videoFeed.addEventListener('error', function() {
            updateStatus('è§†é¢‘æµåŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ‘„åƒå¤´è¿æ¥');
            // ä¸è¦ç«‹å³éšè—ï¼Œè€Œæ˜¯ç­‰å¾…å‡ ç§’åå†å°è¯•é‡æ–°è¿æ¥
            setTimeout(() => {
                if (videoEnabled) {
                    updateStatus('å°è¯•é‡æ–°è¿æ¥è§†é¢‘æµ...');
                    videoFeed.src = '/video_feed?t=' + new Date().getTime();
                }
            }, 5000);
        });

        // å“åº”å¼ç•Œé¢è°ƒæ•´
        function adjustInterface() {
            const isMobile = window.innerWidth < 768;
            const mobileSpeed = document.querySelector('.mobile-speed');
            const desktopSpeed = document.querySelector('.desktop-speed');
            
            if (isMobile) {
                mobileSpeed.style.display = 'block';
                desktopSpeed.style.display = 'none';
            } else {
                mobileSpeed.style.display = 'none';
                desktopSpeed.style.display = 'block';
            }
        }

        // é¡µé¢åŠ è½½å’Œçª—å£å¤§å°æ”¹å˜æ—¶è°ƒæ•´ç•Œé¢
        window.addEventListener('load', adjustInterface);
        window.addEventListener('resize', adjustInterface);

        // åŒæ­¥ä¸¤ä¸ªé€Ÿåº¦æ»‘å—
        const speedDesktop = document.getElementById('speed');
        const speedMobile = document.getElementById('speed-mobile');
        const speedValueDesktop = document.getElementById('speed-value');
        const speedValueMobile = document.getElementById('speed-value-mobile');

        speedDesktop.addEventListener('input', function(e) {
            const value = e.target.value;
            speedMobile.value = value;
            speedValueDesktop.textContent = value + '%';
            speedValueMobile.textContent = value + '%';
        });

        speedMobile.addEventListener('input', function(e) {
            const value = e.target.value;
            speedDesktop.value = value;
            speedValueDesktop.textContent = value + '%';
            speedValueMobile.textContent = value + '%';
        });

        speedMobile.addEventListener('change', function(e) {
            setSpeed(e.target.value);
        });

        // é€Ÿåº¦åˆ‡æ¢æŒ‰é’®åŠŸèƒ½å·²ç§»é™¤ï¼ˆæŒ‰é’®ä¸å­˜åœ¨ï¼‰

        // æ·»åŠ ä¼ æ„Ÿå™¨çŠ¶æ€æ›´æ–°å‡½æ•°
        let sensorUpdateTimer = null;

        // æ›´æ–°ä¼ æ„Ÿå™¨çŠ¶æ€
        function updateSensors() {
            console.log('æ­£åœ¨è·å–ä¼ æ„Ÿå™¨æ•°æ®...');
            fetch('/sensors')
                .then(response => response.json())
                .then(data => {
                    console.log('ä¼ æ„Ÿå™¨æ•°æ®:', data);
                    // æ›´æ–°è¶…å£°æ³¢è·ç¦»
                    const ultrasonicBadge = document.getElementById('ultrasonic-badge');
                    const ultrasonicValue = document.getElementById('ultrasonic-value');
                    const distance = data.ultrasonic || -1;
                    
                    if (distance > 0) {
                        ultrasonicValue.textContent = `è·ç¦»: ${distance}cm`;
                        if (distance < 20) {
                            ultrasonicBadge.className = 'sensor-badge danger';
                        } else if (distance < 40) {
                            ultrasonicBadge.className = 'sensor-badge warning';
                        } else {
                            ultrasonicBadge.className = 'sensor-badge safe';
                        }
                    } else {
                        ultrasonicValue.textContent = 'è·ç¦»: æ— ä¿¡å·';
                        ultrasonicBadge.className = 'sensor-badge warning';
                    }
                    
                    // æ›´æ–°å·¦ä¾§çº¢å¤–
                    const leftIrBadge = document.getElementById('left-ir-badge');
                    const leftIrValue = document.getElementById('left-ir-value');
                    
                    if (data.left_ir) {
                        leftIrBadge.className = 'sensor-badge danger';
                        leftIrValue.textContent = 'å·¦ä¾§: éšœç¢';
                    } else {
                        leftIrBadge.className = 'sensor-badge safe';
                        leftIrValue.textContent = 'å·¦ä¾§: å®‰å…¨';
                    }
                    
                    // æ›´æ–°å³ä¾§çº¢å¤–
                    const rightIrBadge = document.getElementById('right-ir-badge');
                    const rightIrValue = document.getElementById('right-ir-value');
                    
                    if (data.right_ir) {
                        rightIrBadge.className = 'sensor-badge danger';
                        rightIrValue.textContent = 'å³ä¾§: éšœç¢';
                    } else {
                        rightIrBadge.className = 'sensor-badge safe';
                        rightIrValue.textContent = 'å³ä¾§: å®‰å…¨';
                    }
                })
                .catch(error => {
                    console.error('è·å–ä¼ æ„Ÿå™¨æ•°æ®å¤±è´¥:', error);
                    // ä¼ æ„Ÿå™¨è¿æ¥å¤±è´¥æ—¶æ˜¾ç¤ºè­¦å‘Š
                    document.getElementById('ultrasonic-value').textContent = 'è·ç¦»: è¿æ¥å¤±è´¥';
                    document.getElementById('left-ir-value').textContent = 'å·¦ä¾§: è¿æ¥å¤±è´¥';
                    document.getElementById('right-ir-value').textContent = 'å³ä¾§: è¿æ¥å¤±è´¥';
                });
        }

        // åˆ‡æ¢è‡ªåŠ¨é¿éšœçŠ¶æ€
        function toggleObstacleAvoidance() {
            fetch('/obstacle_avoidance', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                updateStatus(`è‡ªåŠ¨é¿éšœ: ${data.enabled ? 'å¼€å¯' : 'å…³é—­'}`);
            })
            .catch(error => {
                updateStatus(`åˆ‡æ¢è‡ªåŠ¨é¿éšœå¤±è´¥: ${error.message}`);
            });
        }

        // ç»‘å®šè‡ªåŠ¨é¿éšœå¼€å…³äº‹ä»¶
        document.getElementById('avoidance-toggle').addEventListener('change', function(e) {
            toggleObstacleAvoidance();
        });

        // é¡µé¢åŠ è½½æ—¶å¯åŠ¨ä¼ æ„Ÿå™¨æ›´æ–°
        window.addEventListener('load', function() {
            console.log('å¯åŠ¨ä¼ æ„Ÿå™¨æ•°æ®æ›´æ–°å®šæ—¶å™¨...');
            // æ¯500msæ›´æ–°ä¸€æ¬¡ä¼ æ„Ÿå™¨æ•°æ®
            sensorUpdateTimer = setInterval(updateSensors, 500);
            
            // è·å–ç³»ç»ŸçŠ¶æ€ï¼ŒåŒ…æ‹¬è‡ªåŠ¨é¿éšœçŠ¶æ€
            fetch('/status')
                .then(response => response.json())
                .then(data => {
                    // è®¾ç½®è‡ªåŠ¨é¿éšœå¼€å…³çŠ¶æ€
                    document.getElementById('avoidance-toggle').checked = data.auto_avoidance;
                });
        });

        // é¡µé¢å…³é—­æ—¶åœæ­¢ä¼ æ„Ÿå™¨æ›´æ–°
        window.addEventListener('beforeunload', function() {
            if (sensorUpdateTimer) {
                clearInterval(sensorUpdateTimer);
            }
        });

        // ä¼ æ„Ÿå™¨æµ‹è¯•æŒ‰é’®
        document.getElementById('sensor-test-btn').addEventListener('click', function() {
            updateStatus('æ‰‹åŠ¨åˆ·æ–°ä¼ æ„Ÿå™¨æ•°æ®...');
            updateSensors();
            
            // æ˜¾ç¤ºè¯¦ç»†ä¼ æ„Ÿå™¨ä¿¡æ¯
            fetch('/sensors')
                .then(response => response.json())
                .then(data => {
                    updateStatus(`ä¼ æ„Ÿå™¨æ•°æ®: å·¦ä¾§${data.left_ir ? 'æœ‰éšœç¢' : 'å®‰å…¨'}, å³ä¾§${data.right_ir ? 'æœ‰éšœç¢' : 'å®‰å…¨'}, è·ç¦»${data.ultrasonic}cm, é¿éšœ${data.auto_avoidance ? 'å¼€å¯' : 'å…³é—­'}`);
                });
        });
    </script>
</body>
</html> 